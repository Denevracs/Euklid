generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NodeType {
  DEFINITION
  AXIOM
  THEOREM
  OBSERVATION
  COUNTEREXAMPLE
  APPLICATION
}

enum NodeStatus {
  HYPOTHETICAL
  UNDER_REVIEW
  PROVEN
  DISPROVEN
  REVISED
  PROBABILISTIC
}

enum EdgeKind {
  DEPENDS_ON
  PROVES
  DISPROVES
  EXTENDS
  ANALOGOUS_TO
}

enum EvidenceKind {
  FORMAL_PROOF
  REPLICATION
  CITATION
  DATASET
}

enum ActivityAction {
  CREATE_NODE
  UPDATE_NODE
  ADD_EVIDENCE
  CREATE_DISCUSSION
  REPLY
  VOTE
  SUPPORT
  CHALLENGE
  CONTRADICT
  CITE
  REPLICATE
  ENDORSE
  FOLLOW
  FORK
}

enum Role {
  MEMBER
  CONTRIBUTOR
  REVIEWER
  CURATOR
  EDITOR
  ADMIN
}

enum Stance {
  PROVEN
  DISPROVEN
  PROBABILISTIC
}

enum ReactionType {
  ACK
  INSIGHT
  ISSUE
  CHECKED
}

enum UserRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum Tier {
  TIER1
  TIER2
  TIER3
  TIER4
}

enum VoteType {
  AGREE
  DISAGREE
  REPLICATE
  CHALLENGE
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationType {
  EMAIL_DOMAIN
  INSTITUTION_ID
  DOCUMENT_ORG
  PEER_ENDORSE
  ORCID
  SCHOLAR_PROFILE
}

model User {
  id                String             @id @default(uuid())
  name              String?
  email             String             @unique
  image             String?
  role              UserRole           @default(MEMBER)
  handle            String?            @unique
  displayHandle     String?            @unique
  display           String?
  tier              Tier               @default(TIER4)
  bio               String?            @db.Text
  website           String?
  location          String?
  expertise         String[]           @default([])
  lastLoginAt       DateTime?
  lastIp            String?
  followerCount     Int                @default(0)
  followingCount    Int                @default(0)
  postCount         Int                @default(0)
  discussionCount   Int                @default(0)
  roles             RoleAssignment[]
  reputations       UserReputation[]
  isHistorical      Boolean            @default(false)
  legacySource      String?
  legacyWorksCount  Int                @default(0)
  nodes             Node[]             @relation("CreatedNodes")
  evidence          Evidence[]
  activity          Activity[]         @relation("ActorActivities")
  targetActivities  Activity[]         @relation("TargetUserActivities")
  reactions         Reaction[]
  notes             Note[]
  consensusVotes    ConsensusVote[]
  discussions       Discussion[]
  replies           Reply[]
  votes             Vote[]
  ghostReservations GhostReservation[] @relation("GhostReservationMaintainer")
  verifiedDomains   String[]           @default([])
  verifiedDocs      Int                @default(0)
  verificationScore Int                @default(0)
  lastTierEvalAt    DateTime?
  verifiedAt        DateTime?
  verifiedById      String?
  affiliations      Json?
  reputationHistory ReputationHistory[]
  verificationSubmissions VerificationSubmission[]
  reviewedVerificationSubmissions VerificationSubmission[] @relation("VerificationReviewer")
  endorsementsGiven Endorsement[]      @relation("EndorsementsGiven")
  endorsementsReceived Endorsement[]   @relation("EndorsementsReceived")
  userInstitutions  UserInstitution[]
  follows           Follow[]           @relation("FollowFollower")
  followedBy        Follow[]           @relation("FolloweeUser")
  feedItems         FeedItem[]
  moderationEvents  ModerationEvent[]  @relation("ModerationEventsActor")
  moderatedIncidents ModerationEvent[] @relation("ModerationEventsTarget")
  flagsReported     Flag[]             @relation("FlagsReported")
  flagsReviewed     Flag[]             @relation("FlagsReviewed")
  warningsCount     Int                @default(0)
  mutesCount        Int                @default(0)
  bansCount         Int                @default(0)
  isBanned          Boolean            @default(false)
  lastActionAt      DateTime?
  bannedUntil       DateTime?
  banReason         String?
  verifiedBy        User?              @relation("UserVerificationAdmins", fields: [verifiedById], references: [id])
  verifiedUsers     User[]             @relation("UserVerificationAdmins")
  auditLogs         AuditLog[]         @relation("AuditLogActor")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([role])
  @@index([tier])
  @@index([lastTierEvalAt])
  @@index([bannedUntil])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  action     String
  targetType String
  targetId   String
  meta       Json?
  createdAt  DateTime @default(now())
  actor      User?    @relation("AuditLogActor", fields: [actorId], references: [id])

  @@index([actorId])
  @@index([targetType])
}

model AdminSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Node {
  id                 String              @id @default(uuid())
  type               NodeType
  title              String
  statement          String
  status             NodeStatus          @default(HYPOTHETICAL)
  metadata           Json?
  createdById        String
  createdBy          User                @relation("CreatedNodes", fields: [createdById], references: [id])
  outgoingEdges      Edge[]              @relation("OutgoingEdges")
  incomingEdges      Edge[]              @relation("IncomingEdges")
  evidence           Evidence[]
  activity           Activity[]          @relation("TargetNodeActivities")
  disciplineId       String?
  discipline         Discipline?         @relation(fields: [disciplineId], references: [id])
  stance             Stance              @default(PROBABILISTIC)
  derivationsFrom    Derivation[]        @relation("DeriveFrom")
  derivationsTo      Derivation[]        @relation("DeriveTo")
  notes              Note[]
  consensusVotes     ConsensusVote[]
  consensusSnapshots ConsensusSnapshot[]
  discussions        Discussion[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([title])
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([createdById])
  @@index([disciplineId])
}

model Edge {
  id        String   @id @default(uuid())
  fromId    String
  toId      String
  kind      EdgeKind
  weight    Float    @default(1)
  createdAt DateTime @default(now())

  from Node @relation("OutgoingEdges", fields: [fromId], references: [id], onDelete: Cascade)
  to   Node @relation("IncomingEdges", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId, kind])
  @@index([fromId])
  @@index([toId])
}

model Evidence {
  id         String       @id @default(uuid())
  nodeId     String
  kind       EvidenceKind
  uri        String
  hash       String?
  summary    String
  confidence Float?
  addedById  String
  createdAt  DateTime     @default(now())

  node    Node @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  addedBy User @relation(fields: [addedById], references: [id])
  activities Activity[] @relation("TargetEvidenceActivities")

  @@index([nodeId, kind])
  @@index([hash])
  @@index([createdAt])
}

model Activity {
  id                 String         @id @default(uuid())
  actorId            String
  action             ActivityAction
  targetNodeId       String?
  targetDiscussionId String?
  targetUserId       String?
  targetDisciplineId String?
  targetEvidenceId   String?
  weight             Int            @default(1)
  createdAt          DateTime       @default(now())

  actor             User        @relation("ActorActivities", fields: [actorId], references: [id])
  targetNode        Node?       @relation("TargetNodeActivities", fields: [targetNodeId], references: [id], onDelete: Cascade)
  targetDiscussion  Discussion? @relation("TargetDiscussionActivities", fields: [targetDiscussionId], references: [id], onDelete: Cascade)
  targetUser        User?       @relation("TargetUserActivities", fields: [targetUserId], references: [id], onDelete: Cascade)
  targetDiscipline  Discipline? @relation("TargetDisciplineActivities", fields: [targetDisciplineId], references: [id], onDelete: Cascade)
  targetEvidence    Evidence?   @relation("TargetEvidenceActivities", fields: [targetEvidenceId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([actorId])
  @@index([action])
  @@index([targetNodeId])
  @@index([targetDiscussionId])
  @@index([targetUserId])
  @@index([targetDisciplineId])
  @@index([targetEvidenceId])
}

model Follow {
  id                  String      @id @default(uuid())
  followerId          String
  followeeUserId      String?
  followDisciplineId  String?
  createdAt           DateTime    @default(now())

  follower         User        @relation("FollowFollower", fields: [followerId], references: [id], onDelete: Cascade)
  followeeUser     User?       @relation("FolloweeUser", fields: [followeeUserId], references: [id], onDelete: Cascade)
  followDiscipline Discipline? @relation("FollowDiscipline", fields: [followDisciplineId], references: [id], onDelete: Cascade)

  @@index([followerId])
  @@index([followeeUserId])
  @@index([followDisciplineId])
  @@unique([followerId, followeeUserId])
  @@unique([followerId, followDisciplineId])
}

model ReputationHistory {
  id        String   @id @default(uuid())
  userId    String
  delta     Int
  reason    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ModerationEvent {
  id           String   @id @default(uuid())
  actorId      String
  targetUserId String?
  targetType   String
  targetId     String
  action       String
  reason       String?
  note         String?
  weight       Int      @default(1)
  expiresAt    DateTime?
  createdAt    DateTime @default(now())

  actor      User @relation("ModerationEventsActor", fields: [actorId], references: [id])
  targetUser User? @relation("ModerationEventsTarget", fields: [targetUserId], references: [id])

  @@index([targetUserId])
  @@index([action])
}

model Flag {
  id           String   @id @default(uuid())
  reporterId   String
  targetType   String
  targetId     String
  reason       String
  status       String   @default("PENDING")
  createdAt    DateTime @default(now())
  reviewedById String?
  reviewedAt   DateTime?
  decisionNote String?

  reporter   User @relation("FlagsReported", fields: [reporterId], references: [id])
  reviewedBy User? @relation("FlagsReviewed", fields: [reviewedById], references: [id])

  @@unique([reporterId, targetType, targetId])
  @@index([status])
}

model VerificationSubmission {
  id          String             @id @default(uuid())
  userId      String
  type        VerificationType
  status      VerificationStatus @default(PENDING)
  payload     Json
  reviewerId  String?
  reviewedAt  DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer User? @relation("VerificationReviewer", fields: [reviewerId], references: [id])

  @@index([userId, status, type])
}

model Endorsement {
  id          String @id @default(uuid())
  endorserId  String
  endorseedId String
  weight      Int    @default(1)
  note        String?
  createdAt   DateTime @default(now())

  endorser  User @relation("EndorsementsGiven", fields: [endorserId], references: [id], onDelete: Cascade)
  endorseed User @relation("EndorsementsReceived", fields: [endorseedId], references: [id], onDelete: Cascade)

  @@unique([endorserId, endorseedId])
  @@index([endorseedId])
  @@index([createdAt])
}

model FeedItem {
  id        String   @id @default(uuid())
  ownerId   String
  kind      String
  refId     String
  score     Float    @default(0)
  payload   Json?
  createdAt DateTime @default(now())
  expiresAt DateTime?

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId, createdAt])
  @@index([ownerId, score])
  @@index([createdAt])
}

model Institution {
  id          String @id @default(uuid())
  name        String
  domain      String @unique
  kind        String
  reputation  Int    @default(50)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships UserInstitution[]
}

model UserInstitution {
  id             String @id @default(uuid())
  userId         String
  institutionId  String
  role           String
  startAt        DateTime?
  endAt          DateTime?
  verified       Boolean  @default(false)
  proofUri       String?
  createdAt      DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@unique([userId, institutionId, role])
}

model Book {
  id          String       @id @default(uuid())
  title       String       @unique
  description String?
  disciplines Discipline[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Discipline {
  id          String           @id @default(uuid())
  title       String
  description String?
  bookId      String
  book        Book             @relation(fields: [bookId], references: [id])
  nodes       Node[]
  reputations UserReputation[]
  activities  Activity[]       @relation("TargetDisciplineActivities")
  followers   Follow[]         @relation("FollowDiscipline")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([createdAt])
}

model Derivation {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  from      Node     @relation("DeriveFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to        Node     @relation("DeriveTo", fields: [toId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Discussion {
  id        String   @id @default(uuid())
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id])
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  hidden    Boolean  @default(false)
  contentHash String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  replies   Reply[]
  votes     Vote[]
  activities Activity[] @relation("TargetDiscussionActivities")

  @@index([createdAt])
  @@index([authorId])
  @@index([nodeId])
}

model Reply {
  id           String     @id @default(uuid())
  discussionId String
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  authorId     String
  author       User       @relation(fields: [authorId], references: [id])
  content      String
  hidden       Boolean    @default(false)
  contentHash  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Vote {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  discussionId String
  discussion   Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  type         VoteType
  weight       Float
  createdAt    DateTime   @default(now())

  @@index([discussionId])
  @@index([userId])
  @@index([createdAt])
}

model Note {
  id        String     @id @default(cuid())
  authorId  String
  nodeId    String?
  parentId  String?
  body      String
  createdAt DateTime   @default(now())
  node      Node?      @relation(fields: [nodeId], references: [id])
  parent    Note?      @relation("ThreadParent", fields: [parentId], references: [id])
  children  Note[]     @relation("ThreadParent")
  author    User       @relation(fields: [authorId], references: [id])
  reactions Reaction[]

  @@index([nodeId])
  @@index([authorId])
}

model Reaction {
  id        String       @id @default(cuid())
  noteId    String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())
  note      Note         @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([userId])
}

model RoleAssignment {
  id        String   @id @default(cuid())
  userId    String
  scope     String?
  role      Role
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserReputation {
  id           String      @id @default(cuid())
  userId       String
  disciplineId String?
  score        Int         @default(5)
  updatedAt    DateTime    @updatedAt
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  discipline   Discipline? @relation(fields: [disciplineId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([disciplineId])
}

model ConsensusVote {
  id         String   @id @default(cuid())
  nodeId     String
  voterId    String
  stance     Stance
  confidence Int      @default(50)
  createdAt  DateTime @default(now())
  node       Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  voter      User     @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([nodeId, voterId])
  @@index([nodeId])
  @@index([voterId])
}

model ConsensusSnapshot {
  id        String   @id @default(cuid())
  nodeId    String
  status    Stance
  tallies   Json
  createdAt DateTime @default(now())
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
}

model GhostReservation {
  id           String  @id @default(cuid())
  handle       String  @unique
  display      String
  primaryYears String?
  bioShort     String?
  maintainerId String?
  maintainer   User?   @relation("GhostReservationMaintainer", fields: [maintainerId], references: [id], onDelete: SetNull)
}
